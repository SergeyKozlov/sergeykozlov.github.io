–¢–æ–≥–¥–∞ –≤–æ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤ –æ–¥–Ω–æ–π —Ç–∞—Å–∫–µ —Å —á–∏—Å—Ç—ã–º Jinja2:
---
- name: Build flink_job dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Collect flink_job -> host mapping
      set_fact:
        flink_job_map: >-
          {{
            dict(
              groups['test_flink']
              | map('extract', hostvars)
              | map('community.general.dict_kv', 'flink_job', 'inventory_hostname')
              | sum(start=[])
            )
          }}

    - name: Show flink_job_map
      debug:
        var: flink_job_map



---
- name: Build flink_job dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Build dictionary of job -> host
      set_fact:
        flink_job_map: >-
          {{
            dict(
              groups['test_flink']
              | map('extract', hostvars)
              | map('combine', [{'jobs': (item.flink_job | default([])) }])
              | map('extract', 'inventory_hostname')
              | list
            )
          }}
      when: false


---
- name: Build flink_job dictionary
  hosts: test_flink
  gather_facts: false
  tasks:
    - name: Init empty dictionary on first host
      set_fact:
        flink_job_map: {}
      run_once: true

    - name: Add jobs from each host
      set_fact:
        flink_job_map: >-
          {{
            flink_job_map | combine(
              dict(
                (flink_job | default([])) | zip([inventory_hostname] * (flink_job | default([]) | length))
              )
            )
          }}

===============================================================
---
- name: Build flink_job dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Init empty dict
      set_fact:
        flink_job_map: {}

    - name: Collect jobs from each host
      set_fact:
        flink_job_map: >-
          {{
            flink_job_map
            | combine(
                dict(
                  hostvars[item].flink_job | default([]) 
                  | zip([item] * (hostvars[item].flink_job | default([]) | length))
                )
              )
          }}
      loop: "{{ groups['test_flink'] }}"

    - name: Show result
      debug:
        var: flink_job_map

=========================================================
---
- name: Build flink_job dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Init empty dict
      set_fact:
        flink_job_map: {}

    - name: Add jobs from each host in test_flink
      set_fact:
        flink_job_map: >-
          {{
            flink_job_map | combine(
              dict(
                (hostvars[item].flink_job | default([]))
                | zip([item] * (hostvars[item].flink_job | default([]) | length))
              )
            )
          }}
      loop: "{{ groups['test_flink'] }}"

    - name: Show result
      debug:
        var: flink_job_map

============================================================

3. –ï—Å–ª–∏ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è ini-–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ üòÖ

–ú–æ–∂–Ω–æ —Ç–∞–∫:

[test_flink]
server1.localhost.ru flink_job="aaaa,bbbb,cccc"
server2.localhost.ru flink_job="dddd,eeee,ffff"


–ê –ø–æ—Ç–æ–º –≤ –ø–ª–µ–π–±—É–∫–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫:

- set_fact:
    flink_job_list: "{{ flink_job.split(',') }}"

============================================================

---
- name: Build flink_job dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Init empty dict
      set_fact:
        flink_job_map: {}

    - name: Collect jobs from each host
      set_fact:
        flink_job_map: >-
          {{
            flink_job_map
            | combine(
                dict(
                  (hostvars[item].flink_job | default("") | split(","))
                  | zip([item] * (hostvars[item].flink_job | default("") | split(",") | length))
                )
              )
          }}
      loop: "{{ groups['test_flink'] }}"

    - name: Show result
      debug:
        var: flink_job_map


22092025 ============================================
–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –ø—Ä–æ—Ö–æ–¥–æ–≤ –ø–æ —Ö–æ—Å—Ç-–≥—Ä—É–ø–ø–µ ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ `set_fact` –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ `loop` –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `flink_job_map` –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ, –∞ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ Ansible –≤—ã–ø–æ–ª–Ω—è–µ—Ç `set_fact` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞, –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–æ—Ö–æ–¥–∞–º –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º.

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω `set_fact` —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –≤–Ω–µ —Ü–∏–∫–ª–∞:

–í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:

```yaml
- name: Init empty dict
  set_fact:
    flink_job_map: {}

- name: Collect jobs from all hosts in one pass
  set_fact:
    flink_job_map: >-
      {{
        dict(
          groups['test_flink']
          | map('extract', hostvars)
          | selectattr('flink_job', 'defined')
          | map('combine', {
              'jobs': (
                hostvars[item].flink_job
                | default("")
                | regex_replace('[\\[\\]\\s]', '')  # —É–¥–∞–ª—è–µ–º —Å–∫–æ–±–∫–∏ –∏ –ø—Ä–æ–±–µ–ª—ã
                | split(',')
              )
            })
          | map('community.general.dict_kv', attribute='jobs', value='inventory_hostname')
          | list
          | sum(start={})
        )
      }}
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –ø–æ–ø—Ä–æ—â–µ (–µ—Å–ª–∏ `flink_job` —É–∂–µ –∫–∞–∫ —Å–ø–∏—Å–æ–∫):

–ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `flink_job` –≤ `inventory` —É–∂–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Å–ø–∏—Å–æ–∫ (–∞ –Ω–µ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ —Å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏), –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å:

```yaml
- name: Collect jobs from all hosts
  set_fact:
    flink_job_map: >-
      {{
        dict(
          groups['test_flink']
          | selectattr('flink_job', 'defined')
          | map('extract', hostvars)
          | map('community.general.dict_kv', attribute='flink_job', value='inventory_hostname')
          | list
          | sum(start={})
        )
      }}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

–í–º–µ—Å—Ç–æ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ `set_fact`, —Ç–µ–ø–µ—Ä—å –≤—Å–µ –¥–∂–æ–±—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥, –∏ `flink_job_map` –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

```yaml
flink_job_map:
  aaaa: server1.localhost.ru
  bbbb: server1.localhost.ru
  cccc: server1.localhost.ru
  dddd: server2.localhost.ru
  eeee: server2.localhost.ru
  ffff: server2.localhost.ru
```

–•–æ—á–µ—à—å, —è –ø–æ–º–æ–≥—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–≤–æ–µ–≥–æ `inventory` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è `flink_job` –≤ —Ç–≤–æ–µ–π —Å—Ä–µ–¥–µ?
