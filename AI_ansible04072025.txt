–°–¥–µ–ª–∞–π —Ç–∞—Å–∫—É Ansible –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å:
–û–±—ä—è–≤–ª—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é count_before.
–í—ã–ø–æ–ª–Ω—è—Ç—å –º–æ–¥—É–ª—å shell —Å –∫–æ–º–∞–Ω–¥–∞–º–∏:
–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ 15 –∏–Ω—Ç–µ—Ä–∞—Ü–∏–π.
–í –∫–∞–∂–¥–æ–π –∏–Ω—Ç–µ—Ä–∞—Ü–∏–∏ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å REST API —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑:
echo ... –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ... |
openssl –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
–†–∞—Å–ø–∞—Ä–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç rest api:
–û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É.
–ò–∑ —Å—Ç–æ—Ä–∏ –≤—ã—Ç–∞—â–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π task_count.
–ï—Å–ª–∏ `task_count == count_before`, —Ç–æ –ø—Ä–µ—Ä–≤–∞—Ç—å —Ü–∏–∫–ª.
–ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ—Ç rest api –Ω–µ—Ç "http:200", —Ç–æ –ø—Ä–µ—Ä–≤–∞—Ç—å —Ü–∏–∫–ª.
–í—ã–≤–æ–¥–∏—Ç—å –Ω–æ–º–µ—Ä –∏–Ω—Ç–µ—Ä–∞—Ü–∏–∏ –∏ task_count –Ω–∞ —ç–∫—Ä–∞–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚Äî –ø–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥.

–í–æ—Ç Ansible —Ç–∞—Å–∫–∞, –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è –æ–ø–∏—Å–∞–Ω–Ω—É—é –≤–∞–º–∏ –ª–æ–≥–∏–∫—É:

* –û–±—ä—è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `count_before`.
* –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–∏–∫–ª –∏–∑ 15 –∏—Ç–µ—Ä–∞—Ü–∏–π.
* –ù–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏:

  * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è REST-–∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `openssl`.
  * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—ã–≤–æ–¥:

    * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ `http:200`.
    * –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `task_count` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏.
    * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å `count_before`.
  * –ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `http:200` ‚Äî —Ü–∏–∫–ª –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è.
  * –í—ã–≤–æ–¥–∏—Ç—Å—è –Ω–æ–º–µ—Ä –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ `task_count`.
  * –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥.

---

## ‚úÖ Ansible playbook-—Ñ—Ä–∞–≥–º–µ–Ω—Ç

```yaml
- name: Loop REST call with openssl and conditional exit
  hosts: localhost
  gather_facts: false
  vars:
    count_before: 42  # –£–∫–∞–∂–∏ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ task_count –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

  tasks:
    - name: REST API polling loop
      vars:
        max_iterations: 15
      block:
        - name: Run custom REST call loop
          ansible.builtin.shell: |
            for i in $(seq 1 {{ max_iterations }}); do
              echo "Iteration $i: Starting"

              RESPONSE=$(echo "some request parameters" | openssl s_client -connect example.com:443 -quiet 2>/dev/null)

              LAST_LINE=$(echo "$RESPONSE" | tail -n 1)
              TASK_COUNT=$(echo "$LAST_LINE" | grep -oP 'task_count\s*=\s*\K\d+')

              echo "$RESPONSE" | grep -q "http:200"
              if [ $? -ne 0 ]; then
                echo "Iteration $i: No http:200 found, exiting"
                exit 1
              fi

              echo "Iteration $i: task_count=$TASK_COUNT"

              if [ "$TASK_COUNT" = "{{ count_before }}" ]; then
                echo "Iteration $i: task_count matched count_before, exiting"
                exit 0
              fi

              sleep 5
            done
          register: rest_loop_output
          changed_when: false

        - name: Show shell loop output
          debug:
            var: rest_loop_output.stdout_lines
```

---

## üìù –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:

* –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `count_before` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `vars`.
* `openssl s_client` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: `example.com:443`) ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∞–¥—Ä–µ—Å.
* `tail -n 1` –æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É.
* `grep -oP` —Å `\K` –∏–∑–≤–ª–µ–∫–∞–µ—Ç `task_count=...`.
* –ü—Ä–æ–≤–µ—Ä–∫–∞ `http:200` –∏—â–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç.
* –ü–∞—É–∑–∞ `sleep 5` –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏.
* –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Äî —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ü–∏–∫–ª –¥–æ—Å—Ä–æ—á–Ω–æ (`exit`).

---

üîß **–ó–∞–º–µ–Ω–∏—Ç–µ**:

* `example.com:443` –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.
* `"some request parameters"` ‚Äî –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π payload –∑–∞–ø—Ä–æ—Å–∞.
* `task_count=...` ‚Äî –Ω–∞ –≤–∞—à —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.

–•–æ—á–µ—à—å, —è –ø–µ—Ä–µ–ø–∏—à—É –ø–æ–¥ `uri` –º–æ–¥—É–ª—å –≤–º–µ—Å—Ç–æ `openssl` (–µ—Å–ª–∏ REST API —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)?











